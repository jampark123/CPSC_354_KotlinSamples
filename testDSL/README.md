Based on code from Kodeco and Adobe
